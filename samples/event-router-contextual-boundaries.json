{
  "id": "event-router-contextual-boundaries",
  "canvas": { "width": 1600, "height": 1200 },
  "bg": "#87CEEB",
  "defs": {
    "filters": [
      "<filter id=\"sceneShadow\" x=\"-20%\" y=\"-20%\" width=\"140%\" height=\"140%\"><feDropShadow dx=\"0\" dy=\"4\" stdDeviation=\"8\" flood-color=\"#000\" flood-opacity=\"0.25\"/></filter>",
      "<filter id=\"busGlow\"><feGaussianBlur stdDeviation=\"2\" result=\"b\"/><feMerge><feMergeNode in=\"b\"/><feMergeNode in=\"SourceGraphic\"/></feMerge></filter>",
      "<filter id=\"activeGlow\"><feGaussianBlur stdDeviation=\"4\" result=\"b\"/><feMerge><feMergeNode in=\"b\"/><feMergeNode in=\"SourceGraphic\"/></feMerge></filter>"
    ],
    "gradients": [
      "<linearGradient id=\"roadGradient\" x1=\"0\" y1=\"0\" x2=\"1\" y2=\"0\"><stop offset=\"0\" stop-color=\"#404040\"/><stop offset=\"0.5\" stop-color=\"#505050\"/><stop offset=\"1\" stop-color=\"#404040\"/></linearGradient>",
      "<linearGradient id=\"busGradient\" x1=\"0\" y1=\"0\" x2=\"1\" y2=\"0\"><stop offset=\"0\" stop-color=\"#FFD700\"/><stop offset=\"0.5\" stop-color=\"#FFA500\"/><stop offset=\"1\" stop-color=\"#FFD700\"/></linearGradient>",
      "<linearGradient id=\"skyGradient\" x1=\"0\" y1=\"0\" x2=\"0\" y2=\"1\"><stop offset=\"0\" stop-color=\"#87CEEB\"/><stop offset=\"1\" stop-color=\"#B0E0E6\"/></linearGradient>"
    ]
  },
  "nodes": [
    {
      "kind": "boundary",
      "id": "scene-1-depot",
      "title": "Scene 1: Publisher Origin (Depot)",
      "at": { "x": 50, "y": 50 },
      "size": { "width": 480, "height": 280 },
      "style": { 
        "fill": "#E8F4FD", 
        "stroke": "#1976D2", 
        "strokeWidth": 2, 
        "labelColor": "#1976D2",
        "filter": "url(#sceneShadow)"
      },
      "grid": { "cols": 3, "rowH": 80, "gutter": 16, "padding": 20 },
      "policy": { "mode": "strict", "overflow": "clip", "tolerance": 2, "snap": { "grid": 4 } },
      "children": [
        {
          "kind": "shape",
          "id": "depot-building",
          "at": { "x": 20, "y": 20 },
          "size": { "width": 120, "height": 80 },
          "shape": "roundedRect",
          "style": { "fill": "#8B7355", "stroke": "#6B5535", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "depot-label",
          "at": { "x": 80, "y": 45 },
          "text": "BUS DEPOT",
          "style": { "fill": "#FFFFFF", "fontSize": 12, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "shape",
          "id": "depot-road",
          "at": { "x": 160, "y": 60 },
          "size": { "width": 280, "height": 40 },
          "shape": "rect",
          "style": { "fill": "url(#roadGradient)", "stroke": "#606060", "strokeWidth": 1 }
        },
        {
          "kind": "shape",
          "id": "bus-scene-1",
          "at": { "x": 200, "y": 50 },
          "size": { "width": 80, "height": 30 },
          "shape": "roundedRect",
          "style": { "fill": "url(#busGradient)", "stroke": "#CC8400", "strokeWidth": 2, "filter": "url(#busGlow)" }
        },
        {
          "kind": "text",
          "id": "scene-1-caption",
          "at": { "x": 240, "y": 140 },
          "text": "publish(topic, payload)",
          "style": { "fill": "#1976D2", "fontSize": 14, "fontWeight": "bold", "textAnchor": "middle" }
        }
      ]
    },
    {
      "kind": "boundary",
      "id": "scene-2-manifest",
      "title": "Scene 2: Route Planning (Manifest + Debounce)",
      "at": { "x": 580, "y": 50 },
      "size": { "width": 480, "height": 280 },
      "style": { 
        "fill": "#FFF3E0", 
        "stroke": "#F57C00", 
        "strokeWidth": 2, 
        "labelColor": "#F57C00",
        "filter": "url(#sceneShadow)"
      },
      "grid": { "cols": 3, "rowH": 80, "gutter": 16, "padding": 20 },
      "policy": { "mode": "strict", "overflow": "clip", "tolerance": 2, "snap": { "grid": 4 } },
      "children": [
        {
          "kind": "shape",
          "id": "traffic-light",
          "at": { "x": 60, "y": 20 },
          "size": { "width": 30, "height": 80 },
          "shape": "roundedRect",
          "style": { "fill": "#333333", "stroke": "#222222", "strokeWidth": 2 }
        },
        {
          "kind": "shape",
          "id": "yellow-light",
          "at": { "x": 68, "y": 45 },
          "size": { "width": 14, "height": 14 },
          "shape": "circle",
          "style": { "fill": "#FFFF00", "stroke": "#CCCC00", "strokeWidth": 1, "filter": "url(#activeGlow)" }
        },
        {
          "kind": "shape",
          "id": "manifest-billboard",
          "at": { "x": 120, "y": 30 },
          "size": { "width": 200, "height": 60 },
          "shape": "roundedRect",
          "style": { "fill": "#FFFFFF", "stroke": "#CCCCCC", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "manifest-content",
          "at": { "x": 220, "y": 50 },
          "text": "{ topic, routes, perf.debounceMs }",
          "style": { "fill": "#333333", "fontSize": 11, "fontFamily": "monospace", "textAnchor": "middle" }
        },
        {
          "kind": "shape",
          "id": "street-sign",
          "at": { "x": 350, "y": 40 },
          "size": { "width": 100, "height": 40 },
          "shape": "roundedRect",
          "style": { "fill": "#4CAF50", "stroke": "#388E3C", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "logs-label",
          "at": { "x": 400, "y": 55 },
          "text": "Logs â–¶ routing",
          "style": { "fill": "#FFFFFF", "fontSize": 10, "fontFamily": "monospace", "textAnchor": "middle" }
        },
        {
          "kind": "text",
          "id": "scene-2-caption",
          "at": { "x": 240, "y": 140 },
          "text": "Manifest plans route; debounce settles bursts",
          "style": { "fill": "#F57C00", "fontSize": 14, "fontWeight": "bold", "textAnchor": "middle" }
        }
      ]
    },
    {
      "kind": "boundary",
      "id": "scene-3-subscribers",
      "title": "Scene 3: First Stop (Live & Late Subscribers)",
      "at": { "x": 1120, "y": 50 },
      "size": { "width": 430, "height": 280 },
      "style": { 
        "fill": "#E8F5E8", 
        "stroke": "#4CAF50", 
        "strokeWidth": 2, 
        "labelColor": "#4CAF50",
        "filter": "url(#sceneShadow)"
      },
      "grid": { "cols": 3, "rowH": 80, "gutter": 16, "padding": 20 },
      "policy": { "mode": "strict", "overflow": "clip", "tolerance": 2, "snap": { "grid": 4 } },
      "children": [
        {
          "kind": "shape",
          "id": "bus-shelter",
          "at": { "x": 20, "y": 40 },
          "size": { "width": 180, "height": 60 },
          "shape": "roundedRect",
          "style": { "fill": "#FFFFFF", "stroke": "#CCCCCC", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "live-subscriber",
          "at": { "x": 60, "y": 60 },
          "text": "LIVE SUB",
          "style": { "fill": "#4CAF50", "fontSize": 12, "fontWeight": "bold" }
        },
        {
          "kind": "text",
          "id": "late-subscriber",
          "at": { "x": 140, "y": 60 },
          "text": "LATE SUB",
          "style": { "fill": "#FF9800", "fontSize": 12, "fontWeight": "bold" }
        },
        {
          "kind": "shape",
          "id": "replay-cache",
          "at": { "x": 220, "y": 30 },
          "size": { "width": 80, "height": 80 },
          "shape": "roundedRect",
          "style": { "fill": "#E1F5FE", "stroke": "#0288D1", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "cache-label",
          "at": { "x": 260, "y": 55 },
          "text": "REPLAY",
          "style": { "fill": "#0288D1", "fontSize": 10, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "text",
          "id": "cache-content",
          "at": { "x": 260, "y": 70 },
          "text": "ðŸ“¦ cache",
          "style": { "fill": "#0288D1", "fontSize": 10, "textAnchor": "middle" }
        },
        {
          "kind": "text",
          "id": "scene-3-caption",
          "at": { "x": 215, "y": 140 },
          "text": "Live & late subscribers; Replay Cache hydrates",
          "style": { "fill": "#4CAF50", "fontSize": 14, "fontWeight": "bold", "textAnchor": "middle" }
        }
      ]
    },
    {
      "kind": "boundary",
      "id": "scene-4-conductor",
      "title": "Scene 4: Transfer Hub (Conductor Orchestration)",
      "at": { "x": 50, "y": 380 },
      "size": { "width": 480, "height": 280 },
      "style": { 
        "fill": "#F3E5F5", 
        "stroke": "#9C27B0", 
        "strokeWidth": 2, 
        "labelColor": "#9C27B0",
        "filter": "url(#sceneShadow)"
      },
      "grid": { "cols": 3, "rowH": 80, "gutter": 16, "padding": 20 },
      "policy": { "mode": "strict", "overflow": "clip", "tolerance": 2, "snap": { "grid": 4 } },
      "children": [
        {
          "kind": "shape",
          "id": "transfer-hub",
          "at": { "x": 160, "y": 40 },
          "size": { "width": 120, "height": 80 },
          "shape": "circle",
          "style": { "fill": "#E1BEE7", "stroke": "#9C27B0", "strokeWidth": 3 }
        },
        {
          "kind": "text",
          "id": "conductor-icon",
          "at": { "x": 220, "y": 70 },
          "text": "ðŸŽ¼",
          "style": { "fontSize": 24, "textAnchor": "middle" }
        },
        {
          "kind": "text",
          "id": "conductor-label",
          "at": { "x": 220, "y": 90 },
          "text": "conductor.play()",
          "style": { "fill": "#9C27B0", "fontSize": 11, "fontFamily": "monospace", "textAnchor": "middle" }
        },
        {
          "kind": "shape",
          "id": "route-a",
          "at": { "x": 320, "y": 20 },
          "size": { "width": 100, "height": 30 },
          "shape": "roundedRect",
          "style": { "fill": "#FFCDD2", "stroke": "#F44336", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "route-a-label",
          "at": { "x": 370, "y": 35 },
          "text": "SEQUENCE A",
          "style": { "fill": "#F44336", "fontSize": 10, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "shape",
          "id": "route-b",
          "at": { "x": 320, "y": 60 },
          "size": { "width": 100, "height": 30 },
          "shape": "roundedRect",
          "style": { "fill": "#C8E6C9", "stroke": "#4CAF50", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "route-b-label",
          "at": { "x": 370, "y": 75 },
          "text": "SEQUENCE B",
          "style": { "fill": "#4CAF50", "fontSize": 10, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "shape",
          "id": "route-c",
          "at": { "x": 320, "y": 100 },
          "size": { "width": 100, "height": 30 },
          "shape": "roundedRect",
          "style": { "fill": "#BBDEFB", "stroke": "#2196F3", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "route-c-label",
          "at": { "x": 370, "y": 115 },
          "text": "SEQUENCE C",
          "style": { "fill": "#2196F3", "fontSize": 10, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "text",
          "id": "scene-4-caption",
          "at": { "x": 240, "y": 160 },
          "text": "Topics route into sequences via Conductor (plugins)",
          "style": { "fill": "#9C27B0", "fontSize": 14, "fontWeight": "bold", "textAnchor": "middle" }
        }
      ]
    },
    {
      "kind": "boundary",
      "id": "scene-5-rules",
      "title": "Scene 5: Rules of the Road (Boundaries & Performance)",
      "at": { "x": 580, "y": 380 },
      "size": { "width": 480, "height": 280 },
      "style": { 
        "fill": "#FFF8E1", 
        "stroke": "#FF9800", 
        "strokeWidth": 2, 
        "labelColor": "#FF9800",
        "filter": "url(#sceneShadow)"
      },
      "grid": { "cols": 3, "rowH": 80, "gutter": 16, "padding": 20 },
      "policy": { "mode": "strict", "overflow": "clip", "tolerance": 2, "snap": { "grid": 4 } },
      "children": [
        {
          "kind": "shape",
          "id": "guardrails",
          "at": { "x": 20, "y": 80 },
          "size": { "width": 440, "height": 8 },
          "shape": "rect",
          "style": { "fill": "#757575", "stroke": "#424242", "strokeWidth": 1 }
        },
        {
          "kind": "shape",
          "id": "loop-prevention-sign",
          "at": { "x": 40, "y": 20 },
          "size": { "width": 100, "height": 40 },
          "shape": "roundedRect",
          "style": { "fill": "#FFEB3B", "stroke": "#F57F17", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "loop-sign-text",
          "at": { "x": 90, "y": 35 },
          "text": "âš  Loop Prevention",
          "style": { "fill": "#F57F17", "fontSize": 9, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "shape",
          "id": "isolation-sign",
          "at": { "x": 160, "y": 20 },
          "size": { "width": 100, "height": 40 },
          "shape": "roundedRect",
          "style": { "fill": "#E3F2FD", "stroke": "#1976D2", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "isolation-sign-text",
          "at": { "x": 210, "y": 35 },
          "text": "ðŸ§ª Handler Isolation",
          "style": { "fill": "#1976D2", "fontSize": 9, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "shape",
          "id": "feature-flags-sign",
          "at": { "x": 280, "y": 20 },
          "size": { "width": 100, "height": 40 },
          "shape": "roundedRect",
          "style": { "fill": "#E8F5E8", "stroke": "#4CAF50", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "flags-sign-text",
          "at": { "x": 330, "y": 35 },
          "text": "ðŸ”€ Feature Flags",
          "style": { "fill": "#4CAF50", "fontSize": 9, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "text",
          "id": "throttle-lane",
          "at": { "x": 120, "y": 110 },
          "text": "THROTTLE ||||||||",
          "style": { "fill": "#FF5722", "fontSize": 12, "fontFamily": "monospace", "fontWeight": "bold" }
        },
        {
          "kind": "text",
          "id": "debounce-lane",
          "at": { "x": 320, "y": 110 },
          "text": "DEBOUNCE â–¼ â—",
          "style": { "fill": "#3F51B5", "fontSize": 12, "fontFamily": "monospace", "fontWeight": "bold" }
        },
        {
          "kind": "text",
          "id": "scene-5-caption",
          "at": { "x": 240, "y": 160 },
          "text": "Enforced boundaries, flags, throttle & debounce lanes",
          "style": { "fill": "#FF9800", "fontSize": 14, "fontWeight": "bold", "textAnchor": "middle" }
        }
      ]
    },
    {
      "kind": "boundary",
      "id": "scene-6-destination",
      "title": "Scene 6: Final Destination (Application State)",
      "at": { "x": 1120, "y": 380 },
      "size": { "width": 430, "height": 280 },
      "style": { 
        "fill": "#E8F5E8", 
        "stroke": "#2E7D32", 
        "strokeWidth": 2, 
        "labelColor": "#2E7D32",
        "filter": "url(#sceneShadow)"
      },
      "grid": { "cols": 3, "rowH": 80, "gutter": 16, "padding": 20 },
      "policy": { "mode": "strict", "overflow": "clip", "tolerance": 2, "snap": { "grid": 4 } },
      "children": [
        {
          "kind": "shape",
          "id": "school-building",
          "at": { "x": 120, "y": 20 },
          "size": { "width": 160, "height": 100 },
          "shape": "roundedRect",
          "style": { "fill": "#FFCDD2", "stroke": "#D32F2F", "strokeWidth": 3 }
        },
        {
          "kind": "text",
          "id": "school-icon",
          "at": { "x": 200, "y": 50 },
          "text": "ðŸ«",
          "style": { "fontSize": 32, "textAnchor": "middle" }
        },
        {
          "kind": "text",
          "id": "school-label",
          "at": { "x": 200, "y": 80 },
          "text": "APPLICATION STATE",
          "style": { "fill": "#D32F2F", "fontSize": 12, "fontWeight": "bold", "textAnchor": "middle" }
        },
        {
          "kind": "text",
          "id": "ui-updated",
          "at": { "x": 200, "y": 95 },
          "text": "[UI Updated]",
          "style": { "fill": "#2E7D32", "fontSize": 10, "fontFamily": "monospace", "textAnchor": "middle" }
        },
        {
          "kind": "shape",
          "id": "final-bus",
          "at": { "x": 20, "y": 80 },
          "size": { "width": 80, "height": 30 },
          "shape": "roundedRect",
          "style": { "fill": "url(#busGradient)", "stroke": "#CC8400", "strokeWidth": 2 }
        },
        {
          "kind": "text",
          "id": "children-disembark",
          "at": { "x": 320, "y": 100 },
          "text": "ðŸ‘¦ðŸ‘§ðŸ‘¦",
          "style": { "fontSize": 20 }
        },
        {
          "kind": "text",
          "id": "scene-6-caption",
          "at": { "x": 215, "y": 160 },
          "text": "Destination reached: application state updated",
          "style": { "fill": "#2E7D32", "fontSize": 14, "fontWeight": "bold", "textAnchor": "middle" }
        }
      ]
    }
  ],
  "ports": [
    {
      "id": "depot-out",
      "nodeId": "scene-1-depot",
      "side": "right",
      "offset": 140
    },
    {
      "id": "manifest-in",
      "nodeId": "scene-2-manifest",
      "side": "left",
      "offset": 140
    },
    {
      "id": "manifest-out",
      "nodeId": "scene-2-manifest",
      "side": "right",
      "offset": 140
    },
    {
      "id": "subscribers-in",
      "nodeId": "scene-3-subscribers",
      "side": "left",
      "offset": 140
    },
    {
      "id": "conductor-in",
      "nodeId": "scene-4-conductor",
      "side": "top",
      "offset": 240
    },
    {
      "id": "conductor-out",
      "nodeId": "scene-4-conductor",
      "side": "right",
      "offset": 140
    },
    {
      "id": "rules-in",
      "nodeId": "scene-5-rules",
      "side": "left",
      "offset": 140
    },
    {
      "id": "rules-out",
      "nodeId": "scene-5-rules",
      "side": "right",
      "offset": 140
    },
    {
      "id": "destination-in",
      "nodeId": "scene-6-destination",
      "side": "left",
      "offset": 140
    }
  ],
  "connectors": [
    {
      "id": "depot-to-manifest",
      "from": { "port": "depot-out" },
      "to": { "port": "manifest-in" },
      "route": "orthogonal",
      "style": { "stroke": "#FFD700", "strokeWidth": 4, "strokeDasharray": "8,4" },
      "label": "Event Published"
    },
    {
      "id": "manifest-to-subscribers",
      "from": { "port": "manifest-out" },
      "to": { "port": "subscribers-in" },
      "route": "orthogonal",
      "style": { "stroke": "#4CAF50", "strokeWidth": 4, "strokeDasharray": "8,4" },
      "label": "Route Planned"
    },
    {
      "id": "subscribers-to-conductor",
      "from": { "port": "subscribers-in" },
      "to": { "port": "conductor-in" },
      "route": "orthogonal",
      "style": { "stroke": "#9C27B0", "strokeWidth": 4, "strokeDasharray": "8,4" },
      "label": "Event Delivered"
    },
    {
      "id": "conductor-to-rules",
      "from": { "port": "conductor-out" },
      "to": { "port": "rules-in" },
      "route": "orthogonal",
      "style": { "stroke": "#FF9800", "strokeWidth": 4, "strokeDasharray": "8,4" },
      "label": "Sequences Triggered"
    },
    {
      "id": "rules-to-destination",
      "from": { "port": "rules-out" },
      "to": { "port": "destination-in" },
      "route": "orthogonal",
      "style": { "stroke": "#2E7D32", "strokeWidth": 4, "strokeDasharray": "8,4" },
      "label": "State Updated"
    }
  ],
  "flows": [
    {
      "id": "bus-journey-flow",
      "path": "depot-to-manifest>manifest-to-subscribers>subscribers-to-conductor>conductor-to-rules>rules-to-destination",
      "token": { 
        "size": 8, 
        "color": "#FFD700", 
        "trail": { "length": 200, "opacity": 0.4 } 
      },
      "speed": 120,
      "loop": true,
      "activate": { 
        "boundaryIds": ["scene-1-depot", "scene-2-manifest", "scene-3-subscribers", "scene-4-conductor", "scene-5-rules", "scene-6-destination"], 
        "className": "active-scene" 
      }
    }
  ]
}
